---
- name: Configure SQLite Backup to Google Drive
  hosts: sandbox
  become: yes
  vars:
    # --- Configuration ---
    # The location of the database you want to backup
    db_path: "/var/lib/myapp/db.sqlite"

    # Where to store the rclone config and credentials on the server
    rclone_config_dir: "/etc/rclone"

    # Where to temporarily store the backup before upload
    backup_staging_dir: "/tmp/sqlite_backups"

    # The rclone remote name (from rclone config)
    rclone_remote_name: "sequoia_fabrica_google_workspace"

    # The folder name inside Google Drive
    drive_folder_name: "sqlite_backups"

    # How often to run (Cron format)
    schedule_hour: "2"
    schedule_minute: "30"

  tasks:
    - name: Install required packages
      apt:
        name:
          - sqlite3
          - rclone
        state: present
        update_cache: yes

    - name: Ensure configuration directory exists
      file:
        path: "{{ rclone_config_dir }}"
        state: directory
        mode: "0700"

    - name: Upload Google Service Account Credentials
      copy:
        src: files/credentials.json
        dest: "{{ rclone_config_dir }}/service_account.json"
        mode: "0600"

    # NOTE: Rclone config is managed manually via OAuth
    # Copy your OAuth config from Mac: cat ~/.config/rclone/rclone.conf | multipass exec sandbox -- sudo tee /etc/rclone/rclone.conf
    # - name: Deploy Rclone Config
    #   template:
    #     src: templates/rclone.conf.j2
    #     dest: "{{ rclone_config_dir }}/rclone.conf"
    #     mode: "0600"

    - name: Deploy Backup Script
      template:
        src: templates/backup_script.sh.j2
        dest: "/usr/local/bin/backup_sqlite.sh"
        mode: "0755"

    - name: Verify Rclone Connection (Dry Run)
      command: "rclone lsd {{ rclone_remote_name }}: --config {{ rclone_config_dir }}/rclone.conf"
      register: rclone_check
      changed_when: false
      failed_when: false

    - name: Alert if Rclone connection failed
      debug:
        msg: "WARNING: Rclone could not list files. Check your Service Account permissions."
      when: rclone_check.rc != 0

    - name: Schedule Daily Backup Cron Job
      cron:
        name: "Daily SQLite Backup"
        minute: "{{ schedule_minute }}"
        hour: "{{ schedule_hour }}"
        job: "/usr/local/bin/backup_sqlite.sh >> /var/log/db_backup.log 2>&1"
