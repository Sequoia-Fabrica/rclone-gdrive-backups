version: "3.8"

services:


  # ============================================================================
  # Google Drive Backup Container
  # Supports multiple SQLite databases in a single container
  # ============================================================================
  gdrive_backup:
    build: .
    # Or use pre-built image:
    # image: sqlite-gdrive-backup:latest
    container_name: myapp_gdrive_backup
    restart: unless-stopped
    environment:
      # ----------------------------------------------------------------------
      # DATABASE CONFIGURATION (use one or more methods)
      # ----------------------------------------------------------------------

      # Method 1: Single database file
      # DB_PATH=/data/db.sqlite

      # Method 2: Multiple specific database files (colon or comma separated)
      # DB_PATHS=/data/users.sqlite:/data/orders.sqlite:/data/logs.sqlite

      # Method 3: Scan directories for databases (colon or comma separated)
      # All files matching DB_PATTERN will be backed up
      - DB_DIRS=/data

      # Pattern for finding databases in DB_DIRS (default: *.sqlite)
      - DB_PATTERN=*.sqlite

      # ----------------------------------------------------------------------
      # GOOGLE DRIVE CONFIGURATION
      # ----------------------------------------------------------------------

      # Rclone remote name (must match your rclone.conf)
      - RCLONE_REMOTE_NAME=gdrive

      # Folder name in Google Drive where backups are stored
      - DRIVE_FOLDER_NAME=sqlite_backups

      # ----------------------------------------------------------------------
      # SCHEDULE CONFIGURATION
      # ----------------------------------------------------------------------

      # Backup schedule (cron format)
      # Default: 2:30 AM daily
      - BACKUP_SCHEDULE=30 2 * * *

      # Run backup immediately when container starts
      - RUN_ON_STARTUP=false

      # ----------------------------------------------------------------------
      # RETENTION CONFIGURATION
      # ----------------------------------------------------------------------

      # Days to keep backups (0 to disable retention policy)
      - RETENTION_DAYS=30

      # ----------------------------------------------------------------------
      # ADVANCED CONFIGURATION (usually no need to change)
      # ----------------------------------------------------------------------

      # Rclone config directory inside container
      - RCLONE_CONFIG_DIR=/etc/rclone

      # Staging directory for backups inside container
      - BACKUP_STAGING_DIR=/backups

    volumes:
      # Mount your database path(s) from the host (read-only for safety)
      # Example for single database:
      # - /var/lib/myapp/db.sqlite:/data/db.sqlite:ro
      # Example for directory of databases:
      # - /var/lib/myapp:/data:ro
      # REPLACE WITH YOUR ACTUAL DATABASE PATH:
      - /path/to/your/database:/data:ro

      # Mount your rclone configuration
      # IMPORTANT: Copy your rclone.conf to ./rclone.conf first!
      # Example: cp ~/.config/rclone/rclone.conf ./rclone.conf
      - ./rclone.conf:/etc/rclone/rclone.conf:ro

      # Optional: Persist logs outside container
      # - ./logs:/var/log

    healthcheck:
      test: ["CMD", "pgrep", "cron"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# volumes:
#   # No named volumes needed - mount host paths directly above

# ============================================================================
# MULTI-DATABASE EXAMPLES
# ============================================================================
#
# Example 1: Single database
#   environment:
#     - DB_PATH=/data/app.sqlite
#
# Example 2: Multiple specific databases
#   environment:
#     - DB_PATHS=/data/users.sqlite:/data/orders.sqlite:/data/products.sqlite
#
# Example 3: Scan directory for all SQLite files
#   environment:
#     - DB_DIRS=/data
#     - DB_PATTERN=*.sqlite
#
# Example 4: Multiple directories
#   environment:
#     - DB_DIRS=/data/app1:/data/app2:/var/lib/myservice
#     - DB_PATTERN=*.sqlite
#
# Example 5: Combined (all methods work together)
#   environment:
#     - DB_PATH=/critical/main.sqlite
#     - DB_PATHS=/other/users.db:/other/logs.db
#     - DB_DIRS=/data/apps
#     - DB_PATTERN=*.sqlite
#
# Example 6: Different file patterns
#   environment:
#     - DB_DIRS=/data
#     - DB_PATTERN=*.db        # For .db extension
#   Or:
#     - DB_PATTERN=app_*.sqlite  # For specific prefix
#
# ============================================================================
# VOLUME MOUNTING EXAMPLES
# ============================================================================
#
# Single database:
#   volumes:
#     - /var/lib/myapp/db.sqlite:/data/db.sqlite:ro
#
# Multiple databases from different locations:
#   volumes:
#     - /var/lib/app1/data.sqlite:/data/app1.sqlite:ro
#     - /var/lib/app2/data.sqlite:/data/app2.sqlite:ro
#     - /var/lib/app3/data.sqlite:/data/app3.sqlite:ro
#
# Entire directory:
#   volumes:
#     - /var/lib/databases:/data:ro
#
# Multiple directories:
#   volumes:
#     - /var/lib/app1:/data/app1:ro
#     - /var/lib/app2:/data/app2:ro
#   environment:
#     - DB_DIRS=/data/app1:/data/app2
#
# ============================================================================
# BACKUP FILE NAMING
# ============================================================================
#
# Backup files are named: {database_name}_backup_{timestamp}.sqlite
#
# Examples:
#   users.sqlite    → users_backup_20241228_143022.sqlite
#   orders.sqlite   → orders_backup_20241228_143022.sqlite
#   app.db          → app_backup_20241228_143022.sqlite
#
# All backups go to the same Google Drive folder (DRIVE_FOLDER_NAME)
#
# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
#
# 1. Set up rclone configuration:
#    rclone config
#    # Create a remote named "gdrive" (or update RCLONE_REMOTE_NAME)
#    # Follow the OAuth flow for Google Drive
#
# 2. Copy your rclone config to this directory:
#    cp ~/.config/rclone/rclone.conf ./rclone.conf
#    chmod 600 ./rclone.conf
#
# 3. Update volume mounts and environment variables for your databases
#
# 4. Start the services:
#    docker-compose up -d
#
# 5. Verify the backup container is running:
#    docker-compose ps
#    docker-compose logs -f gdrive_backup
#
# 6. Run a manual backup to test:
#    docker-compose exec gdrive_backup /scripts/backup_sqlite.sh
#
# 7. Verify backups in Google Drive:
#    rclone ls gdrive:sqlite_backups --config ./rclone.conf
#
# ============================================================================
# USEFUL COMMANDS
# ============================================================================
#
# View logs:
#   docker-compose logs -f gdrive_backup
#
# Run manual backup:
#   docker-compose exec gdrive_backup /scripts/backup_sqlite.sh
#
# Check cron schedule:
#   docker-compose exec gdrive_backup crontab -l
#
# List discovered databases:
#   docker-compose exec gdrive_backup ls -la /data/
#
# Access backup container shell:
#   docker-compose exec gdrive_backup /bin/bash
#
# Stop services:
#   docker-compose down
#
# Rebuild the backup image:
#   docker-compose build gdrive_backup
#   docker-compose up -d gdrive_backup
#
# ============================================================================
