# System Workflow & Architecture

This document provides visual diagrams of how the Google Drive backup system works.

## ğŸ¯ Quick Reference

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Your M3 Mac                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚   Ansible   â”‚â”€â”€â”€â”€â”€â–¶â”‚  Multipass   â”‚                     â”‚
â”‚  â”‚  Playbook   â”‚      â”‚     VM       â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                              â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Ubuntu 22.04 VM    â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ SQLite DB      â”‚  â”‚
                    â”‚  â”‚ Backup Script  â”‚  â”‚
                    â”‚  â”‚ Rclone         â”‚  â”‚
                    â”‚  â”‚ Cron Job       â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Google Drive  â”‚
                        â”‚   (Backups)   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Initial Setup Flow

```
START
  â”‚
  â”œâ”€â–¶ [1] Install Multipass & Ansible
  â”‚     â”‚
  â”‚     â””â”€â–¶ brew install multipass ansible
  â”‚
  â”œâ”€â–¶ [2] Run Setup Script
  â”‚     â”‚
  â”‚     â””â”€â–¶ ./setup_m3.sh
  â”‚           â”‚
  â”‚           â”œâ”€â–¶ Create Ubuntu VM (sandbox)
  â”‚           â”œâ”€â–¶ Configure SSH access
  â”‚           â”œâ”€â–¶ Generate inventory.ini
  â”‚           â”œâ”€â–¶ Create dummy credentials.json
  â”‚           â””â”€â–¶ Create test database
  â”‚
  â”œâ”€â–¶ [3] Run Ansible Playbook
  â”‚     â”‚
  â”‚     â””â”€â–¶ ansible-playbook -i inventory.ini playbook.yml
  â”‚           â”‚
  â”‚           â”œâ”€â–¶ Install packages (sqlite3, rclone)
  â”‚           â”œâ”€â–¶ Deploy rclone config
  â”‚           â”œâ”€â–¶ Deploy backup script
  â”‚           â””â”€â–¶ Schedule cron job
  â”‚
  â””â”€â–¶ [4] Test Backup
        â”‚
        â””â”€â–¶ multipass shell sandbox
              â”‚
              â””â”€â–¶ sudo /usr/local/bin/backup_sqlite.sh
                    â”‚
                    â””â”€â–¶ âš ï¸  Will fail without real credentials
```

---

## ğŸ”„ Daily Backup Workflow

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Cron Daemon   â”‚
                    â”‚  (Every 2:30 AM)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Backup Script  â”‚
                    â”‚   Triggered     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚                   â”‚
         â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 1 â”‚         â”‚ STEP 2  â”‚         â”‚ STEP 3  â”‚
    â”‚ Backup â”‚         â”‚ Upload  â”‚         â”‚ Cleanup â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                   â”‚                    â”‚
        â”‚                   â”‚                    â”‚
        â–¼                   â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite VACUUM â”‚   â”‚ Rclone Copy   â”‚   â”‚ Delete Local â”‚
â”‚ INTO creates  â”‚â”€â”€â–¶â”‚ uploads to    â”‚â”€â”€â–¶â”‚ temp file    â”‚
â”‚ safe backup   â”‚   â”‚ Google Drive  â”‚   â”‚ & old cloud  â”‚
â”‚ copy          â”‚   â”‚               â”‚   â”‚ backups      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                    â”‚
        â”‚                   â”‚                    â”‚
        â–¼                   â–¼                    â–¼
/tmp/sqlite_backups/    Google Drive      Log result to
db_backup_20241228.      /sqlite_backups/  /var/log/
sqlite                   folder            db_backup.log
```

---

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HOST MACHINE (Your M3 Mac)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Project Directory (gdrive_backup_test/)                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ setup_m3.sh         â† Initial setup automation     â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ helper.sh           â† Daily operations helper      â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ diagnose.sh         â† Health check tool            â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ playbook.yml        â† Ansible configuration        â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ inventory.ini       â† VM connection info           â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ files/                                             â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€ credentials.json  â† Google service account    â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  â””â”€â”€ templates/                                         â”‚  â”‚
â”‚  â”‚      â”œâ”€â”€ backup_script.sh.j2   â† Backup logic          â”‚  â”‚
â”‚  â”‚      â””â”€â”€ rclone.conf.j2        â† Drive config          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â”‚ SSH/Ansible                      â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Multipass VM (sandbox)                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Ubuntu 22.04 (ARM64)                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Installed Packages                          â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€ sqlite3       (database engine)         â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€ rclone        (cloud sync tool)         â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ openssh       (remote access)           â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  File System                                 â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                              â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  /var/lib/myapp/                            â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ db.sqlite          â† Your database     â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                              â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  /etc/rclone/                               â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€ rclone.conf        â† Drive config      â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ service_account.json â† Credentials     â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                              â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  /usr/local/bin/                            â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ backup_sqlite.sh   â† Backup script     â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                              â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  /tmp/sqlite_backups/   â† Staging area      â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                              â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  /var/log/                                  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ db_backup.log      â† Backup logs       â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Cron Job                                    â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  30 2 * * * /usr/local/bin/backup_sqlite.sh â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚             â””â”€ Runs daily at 2:30 AM        â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTPS (Rclone API)
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Google Cloud                 â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  â”‚  Google Drive           â”‚  â”‚
            â”‚  â”‚  â””â”€â”€ sqlite_backups/    â”‚  â”‚
            â”‚  â”‚      â”œâ”€â”€ db_backup_...  â”‚  â”‚
            â”‚  â”‚      â”œâ”€â”€ db_backup_...  â”‚  â”‚
            â”‚  â”‚      â””â”€â”€ db_backup_...  â”‚  â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GOOGLE CLOUD CONSOLE                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Create Project                                       â”‚  â”‚
â”‚  â”‚  2. Enable Drive API                                     â”‚  â”‚
â”‚  â”‚  3. Create Service Account                               â”‚  â”‚
â”‚  â”‚  4. Download JSON Key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                        Download credentials.json
                                                â”‚
                                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  YOUR MAC                        â”‚
                        â”‚  files/credentials.json          â”‚
                        â”‚  Contains:                       â”‚
                        â”‚  - client_email                  â”‚
                        â”‚  - private_key                   â”‚
                        â”‚  - project_id                    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                      Ansible copies via playbook
                                  â”‚
                                  â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  VM                              â”‚
                        â”‚  /etc/rclone/service_account.jsonâ”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                          Rclone reads on backup
                                  â”‚
                                  â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Rclone authenticates with:      â”‚
                        â”‚  - Service account email         â”‚
                        â”‚  - Private key (OAuth 2.0)       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                            API Request
                                  â”‚
                                  â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  GOOGLE DRIVE API                â”‚
                        â”‚  - Validates service account     â”‚
                        â”‚  - Checks folder permissions     â”‚
                        â”‚  - Allows file upload            â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NOTE: You must SHARE the Drive folder with the service account email!
      Example: your-service@project.iam.gserviceaccount.com
```

---

## ğŸ”„ Backup Script Execution Detail

```
/usr/local/bin/backup_sqlite.sh
â”‚
â”œâ”€â–¶ [Phase 1] Create Backup
â”‚   â”‚
â”‚   â”œâ”€ Set timestamp: 20241228_143052
â”‚   â”œâ”€ Create staging dir: /tmp/sqlite_backups/
â”‚   â”‚
â”‚   â””â”€â–¶ sqlite3 /var/lib/myapp/db.sqlite \
â”‚       "VACUUM INTO '/tmp/sqlite_backups/db_backup_20241228_143052.sqlite'"
â”‚       â”‚
â”‚       â”œâ”€ âœ“ Transaction-safe copy
â”‚       â”œâ”€ âœ“ No long-duration locks
â”‚       â”œâ”€ âœ“ Compacts database
â”‚       â””â”€ âœ“ Independent file created
â”‚
â”œâ”€â–¶ [Phase 2] Upload to Google Drive
â”‚   â”‚
â”‚   â””â”€â–¶ rclone copy \
â”‚       /tmp/sqlite_backups/db_backup_20241228_143052.sqlite \
â”‚       gdrive:sqlite_backups/ \
â”‚       --config /etc/rclone/rclone.conf
â”‚       â”‚
â”‚       â”œâ”€ âœ“ Reads credentials from service_account.json
â”‚       â”œâ”€ âœ“ Authenticates with Google Drive API
â”‚       â”œâ”€ âœ“ Uploads file to specified folder
â”‚       â””â”€ âœ“ Verifies upload success
â”‚
â”œâ”€â–¶ [Phase 3] Local Cleanup
â”‚   â”‚
â”‚   â””â”€â–¶ rm /tmp/sqlite_backups/db_backup_20241228_143052.sqlite
â”‚       â”‚
â”‚       â””â”€ âœ“ Frees local disk space
â”‚
â”œâ”€â–¶ [Phase 4] Cloud Retention
â”‚   â”‚
â”‚   â””â”€â–¶ rclone delete gdrive:sqlite_backups/ \
â”‚       --min-age 30d \
â”‚       --config /etc/rclone/rclone.conf
â”‚       â”‚
â”‚       â””â”€ âœ“ Removes backups older than 30 days
â”‚
â””â”€â–¶ [Phase 5] Logging
    â”‚
    â””â”€â–¶ All output redirected to /var/log/db_backup.log
        â”‚
        â”œâ”€ Timestamps for each run
        â”œâ”€ Success/failure status
        â””â”€ Error messages (if any)
```

---

## ğŸ“Š Helper Script Menu Flow

```
./helper.sh
    â”‚
    â”œâ”€â–¶ setup          â”€â”€â–¶ ./setup_m3.sh
    â”œâ”€â–¶ deploy         â”€â”€â–¶ ansible-playbook -i inventory.ini playbook.yml
    â”œâ”€â–¶ check          â”€â”€â–¶ ./diagnose.sh
    â”‚
    â”œâ”€â–¶ start          â”€â”€â–¶ multipass start sandbox
    â”œâ”€â–¶ stop           â”€â”€â–¶ multipass stop sandbox
    â”œâ”€â–¶ restart        â”€â”€â–¶ multipass restart sandbox
    â”œâ”€â–¶ shell          â”€â”€â–¶ multipass shell sandbox
    â”œâ”€â–¶ info           â”€â”€â–¶ multipass info sandbox
    â”œâ”€â–¶ delete         â”€â”€â–¶ multipass delete sandbox && purge
    â”‚
    â”œâ”€â–¶ test           â”€â”€â–¶ multipass exec sandbox -- sudo /usr/local/bin/backup_sqlite.sh
    â”œâ”€â–¶ logs           â”€â”€â–¶ multipass exec sandbox -- tail -f /var/log/db_backup.log
    â”œâ”€â–¶ cron           â”€â”€â–¶ multipass exec sandbox -- sudo crontab -l
    â”œâ”€â–¶ db             â”€â”€â–¶ multipass exec sandbox -- ls -l /var/lib/myapp/db.sqlite
    â”‚
    â”œâ”€â–¶ ip             â”€â”€â–¶ multipass info sandbox | grep IPv4
    â”œâ”€â–¶ ping           â”€â”€â–¶ ansible -i inventory.ini sandbox -m ping
    â””â”€â–¶ update-ip      â”€â”€â–¶ Regenerate inventory.ini with current VM IP
```

---

## ğŸš€ Development to Production Path

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DEVELOPMENT (Your M3 Mac)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Test on Multipass VM                                  â”‚  â”‚
â”‚  â”‚     ./setup_m3.sh                                         â”‚  â”‚
â”‚  â”‚     ansible-playbook -i inventory.ini playbook.yml        â”‚  â”‚
â”‚  â”‚     ./helper.sh test                                      â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  2. Verify everything works                               â”‚  â”‚
â”‚  â”‚     âœ“ Database backups created                            â”‚  â”‚
â”‚  â”‚     âœ“ Upload to Drive succeeds                            â”‚  â”‚
â”‚  â”‚     âœ“ Cron job scheduled                                  â”‚  â”‚
â”‚  â”‚     âœ“ Logs show success                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    Same playbook.yml
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRODUCTION (Real Server)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Update inventory.ini with production server           â”‚  â”‚
â”‚  â”‚     [production]                                           â”‚  â”‚
â”‚  â”‚     your-server.com ansible_user=ubuntu                    â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  2. Run the SAME playbook                                  â”‚  â”‚
â”‚  â”‚     ansible-playbook -i inventory.ini playbook.yml        â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  3. Monitor logs on production                             â”‚  â”‚
â”‚  â”‚     ssh user@your-server.com                               â”‚  â”‚
â”‚  â”‚     tail -f /var/log/db_backup.log                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

The beauty: What works in dev WILL work in prod!
```

---

## ğŸ›¡ï¸ Error Handling & Recovery

```
Backup Script Error Scenarios:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Locked                         â”‚
â”‚  â”œâ”€ SQLite VACUUM INTO waits             â”‚
â”‚  â”œâ”€ Eventually acquires lock             â”‚
â”‚  â””â”€ Or fails with clear error            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€ Error logged to /var/log/db_backup.log
                  â””â”€ Cron will retry next scheduled time

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Drive Authentication Failed      â”‚
â”‚  â”œâ”€ Rclone reports auth error            â”‚
â”‚  â”œâ”€ Local backup is still created        â”‚
â”‚  â””â”€ NOT deleted (manual investigation)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€ Error logged with details
                  â””â”€ Check: service account permissions

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Network Connection Lost                 â”‚
â”‚  â”œâ”€ Rclone retries automatically         â”‚
â”‚  â”œâ”€ Eventually times out                 â”‚
â”‚  â””â”€ Local backup preserved               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€ Error logged
                  â””â”€ Retry on next cron run

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Disk Space Full                         â”‚
â”‚  â”œâ”€ Backup creation fails                â”‚
â”‚  â”œâ”€ Script exits with error              â”‚
â”‚  â””â”€ Alert in logs                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€ Check: df -h /tmp
                  â””â”€ Clean up old files
```

---

## ğŸ“ˆ Timeline Example

```
Day 0 (Today)
  09:00 â”‚ Run ./setup_m3.sh
  09:03 â”‚ âœ“ VM created and configured
  09:05 â”‚ Run ansible-playbook
  09:07 â”‚ âœ“ All services deployed
  09:10 â”‚ Test with ./helper.sh test
  09:11 â”‚ âš ï¸  Upload fails (using dummy credentials)

Day 1 (Tomorrow)
  10:00 â”‚ Obtain real Google Drive credentials
  10:05 â”‚ Replace files/credentials.json
  10:10 â”‚ Share Drive folder with service account
  10:15 â”‚ Re-run: ansible-playbook -i inventory.ini playbook.yml
  10:17 â”‚ âœ“ Configuration updated
  10:20 â”‚ Test: ./helper.sh test
  10:21 â”‚ âœ“ Backup uploaded successfully!
  
Day 2 (Automated)
  02:30 â”‚ Cron triggers backup automatically
  02:31 â”‚ âœ“ Database backed up
  02:32 â”‚ âœ“ Uploaded to Drive
  02:33 â”‚ âœ“ Local file cleaned up
  
Day 3...Day 30 (Daily)
  02:30 â”‚ Automatic backups continue
  
Day 31+
  02:30 â”‚ Automatic backup
  02:34 â”‚ âœ“ Old backups (30+ days) deleted from Drive
```

---

## ğŸ“ Key Concepts

### Why Multipass Instead of VirtualBox?
```
VirtualBox on M3 Mac:  âŒ x86 architecture not supported on ARM
Multipass on M3 Mac:   âœ… Native ARM64 support
                       âœ… Faster performance
                       âœ… Lower overhead
                       âœ… Built for cloud-init patterns
```

### Why Ansible?
```
Manual Configuration:   âŒ Error-prone
                       âŒ Hard to replicate
                       âŒ Not version controlled

Ansible (IaC):         âœ… Repeatable
                       âœ… Version controlled
                       âœ… Self-documenting
                       âœ… Dev = Prod setup
```

### Why Service Account?
```
OAuth User Flow:       âŒ Requires browser interaction
                       âŒ Tokens expire
                       âŒ Can't run headless

Service Account:       âœ… Long-lived credentials
                       âœ… Perfect for automation
                       âœ… Works in cron
                       âœ… Scoped permissions
```

---

**For more information, see:**
- `README.md` - Project overview
- `QUICKSTART.md` - 5-minute setup
- `SETUP_M3_MAC.md` - Detailed guide