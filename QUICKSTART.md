# Quick Start Guide - M3 Mac Setup

This guide will get your Google Drive backup system running on your M3 Mac in under 5 minutes.

## What You Need

- **Homebrew** installed
- **15 minutes** of your time

## Step 1: Install Prerequisites

```bash
# Install Multipass (lightweight VM manager for ARM Macs)
brew install multipass

# Install Ansible
brew install ansible
```

## Step 2: Run the Automated Setup Script

This script will:
- Create an Ubuntu VM
- Set up SSH access
- Create a test database
- Generate dummy credentials (since you don't have real ones yet)

```bash
cd gdrive_backup_test
./setup_m3.sh
```

Wait for it to complete (2-3 minutes). You'll see green checkmarks as each step completes.

## Step 3: Run the Ansible Playbook

This will configure everything in the VM:

```bash
ansible-playbook -i inventory.ini playbook.yml
```

Expected output:
- ‚úÖ Packages installed (sqlite3, rclone)
- ‚úÖ Config files deployed
- ‚úÖ Backup script created
- ‚úÖ Cron job scheduled
- ‚ö†Ô∏è  Warning about rclone connection (expected without real credentials)

## Step 4: Test the Backup Script

```bash
# SSH into the VM
multipass shell sandbox

# Run the backup script manually
sudo /usr/local/bin/backup_sqlite.sh
```

**Expected behavior:** 
- ‚úÖ Database backup will be created in `/tmp/sqlite_backups/`
- ‚ùå Upload to Google Drive will fail (expected - you don't have real credentials yet)

The script will show an error about authentication, which is normal at this stage.

## Step 5: Verify Everything Is Set Up

Check that all the pieces are in place:

```bash
# Still inside the VM (multipass shell sandbox)

# Check the backup script exists
ls -l /usr/local/bin/backup_sqlite.sh

# Check the test database exists
sudo ls -l /var/lib/myapp/db.sqlite

# Check rclone config exists
sudo ls -l /etc/rclone/

# Check cron job is scheduled
sudo crontab -l

# Exit the VM
exit
```

## What You've Accomplished

üéâ **Congratulations!** You now have:

1. ‚úÖ A working Ubuntu VM on your M3 Mac
2. ‚úÖ Ansible configured and tested
3. ‚úÖ A test SQLite database
4. ‚úÖ Backup script installed and ready
5. ‚úÖ Automated daily backups scheduled (will work once you add real credentials)

## Next Steps: Configure Google Drive with OAuth

This system uses **OAuth authentication** (not service accounts) to connect to Google Drive.

### 1. Configure Rclone with OAuth on Your Mac

```bash
# Run rclone config interactively
rclone config

# Follow the prompts:
# - Choose: n (New remote)
# - Name: sequoia_fabrica_google_workspace (or your preferred name)
# - Storage: drive (Google Drive)
# - Client ID/Secret: Press Enter (use defaults)
# - Scope: drive (full access)
# - Root folder: Press Enter
# - Service account file: Press Enter (we're using OAuth, not service accounts)
# - Edit advanced config: n
# - Use auto config: y (this will open a browser for OAuth)
# - Log in with your Google account and authorize
```

### 2. Copy OAuth Config to the VM

```bash
# Copy your rclone config with OAuth tokens to the VM
cat ~/.config/rclone/rclone.conf | multipass exec sandbox -- sudo tee /etc/rclone/rclone.conf

# Set proper permissions
multipass exec sandbox -- sudo chmod 600 /etc/rclone/rclone.conf
```

### 3. Verify Connection

```bash
# Test that rclone can connect to Google Drive
multipass exec sandbox -- sudo rclone lsd sequoia_fabrica_google_workspace:

# Create the backup folder
multipass exec sandbox -- sudo rclone mkdir sequoia_fabrica_google_workspace:sqlite_backups
```

### 4. Update Playbook Variables (if needed)

If you used a different remote name, update `playbook.yml`:

```yaml
rclone_remote_name: "your_remote_name_here"
```

### 5. Test with Real Credentials

```bash
multipass shell sandbox
sudo /usr/local/bin/backup_sqlite.sh
```

This time it should work! Check your Google Drive folder for the backup file.

## Useful Commands

```bash
# VM Management
multipass list                    # List all VMs
multipass shell sandbox           # SSH into the VM
multipass stop sandbox            # Stop the VM
multipass start sandbox           # Start the VM
multipass info sandbox            # View VM details (IP, resources, etc.)

# Test Ansible connection
ansible -i inventory.ini sandbox -m ping

# View backup logs (from inside VM)
multipass shell sandbox
tail -f /var/log/db_backup.log
```

## Troubleshooting

### "Can't connect to VM"
```bash
multipass restart sandbox
sleep 10
ansible -i inventory.ini sandbox -m ping
```

### "Update IP address in inventory"
```bash
# Get new IP
multipass info sandbox | grep IPv4

# Then edit inventory.ini and replace the IP address
```

### "Start fresh"
```bash
multipass delete sandbox
multipass purge
./setup_m3.sh
```

## File Structure

```
gdrive_backup_test/
‚îú‚îÄ‚îÄ setup_m3.sh              # Automated setup script (run this first!)
‚îú‚îÄ‚îÄ inventory.ini            # Ansible inventory (auto-generated by setup script)
‚îú‚îÄ‚îÄ playbook.yml             # Ansible playbook (main configuration)
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ backup_script.sh.j2  # Backup script template
‚îÇ   ‚îî‚îÄ‚îÄ rclone.conf.j2       # Rclone configuration template (OAuth)
‚îî‚îÄ‚îÄ SETUP_M3_MAC.md          # Detailed setup documentation
```

## Need More Details?

See `SETUP_M3_MAC.md` for:
- Detailed explanations of each step
- Advanced troubleshooting
- Manual setup instructions
- Understanding how everything works

## Support

If you run into issues:
1. Check `SETUP_M3_MAC.md` for detailed troubleshooting
2. Run `multipass info sandbox` to verify VM status
3. Check logs: `multipass shell sandbox` then `sudo tail /var/log/db_backup.log`

---

**You're all set!** The system will automatically back up your database daily at 2:30 AM once you add real Google Drive credentials.