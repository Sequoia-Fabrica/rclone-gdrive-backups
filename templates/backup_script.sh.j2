#!/bin/bash
set -e

# Configuration
DB_PATH="{{ db_path }}"
BACKUP_DIR="{{ backup_staging_dir }}"
REMOTE_NAME="{{ rclone_remote_name }}"
REMOTE_FOLDER="{{ drive_folder_name }}"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="db_backup_${TIMESTAMP}.sqlite"

# Ensure backup dir exists
mkdir -p "$BACKUP_DIR"

# 1. Safe Hot Backup using SQLite VACUUM INTO
# This creates a transaction-safe copy without locking the DB for long
sqlite3 "$DB_PATH" "VACUUM INTO '$BACKUP_DIR/$BACKUP_NAME'"

# 2. Upload to Google Drive
# We reference the config explicitly to avoid environment variable issues in cron
/usr/bin/rclone copy "$BACKUP_DIR/$BACKUP_NAME" "$REMOTE_NAME:$REMOTE_FOLDER" \
  --config {{ rclone_config_dir }}/rclone.conf

# 3. Cleanup Local File
rm "$BACKUP_DIR/$BACKUP_NAME"

# 4. Retention (Optional: Delete cloud backups older than 30 days)
/usr/bin/rclone delete "$REMOTE_NAME:$REMOTE_FOLDER" --min-age 30d \
  --config {{ rclone_config_dir }}/rclone.conf
